---
title: "p8105_hw6_mx2286"
author: "William Xie"
date: "2024-12-01"
output: github_document
---

```{r}
library(tidyverse)
library(rnoaa)
library(broom)
library(modelr)
```

```{r}
# Pull weather data
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

# Bootstrap function
bootstrap_function <- function(data, n_bootstrap = 5000) {
  # Initialize vectors to store results
  r_squared_values <- numeric(n_bootstrap)
  log_beta_product_values <- numeric(n_bootstrap)
  
  for (i in 1:n_bootstrap) {
    # Sample with replacement
    boot_sample <- data %>%
      slice_sample(n = nrow(data), replace = TRUE)
    
    # Perform linear regression
    model <- lm(tmax ~ tmin, data = boot_sample)
    
    # Extract R^2
    r_squared_values[i] <- glance(model)$r.squared
    
    # Extract regression coefficients
    beta_coefficients <- coef(model)
    beta_0 <- beta_coefficients[1]
    beta_1 <- beta_coefficients[2]
    
    # Compute log(β0 * β1), avoiding log(0) or negative issues
    if (!is.na(beta_0 * beta_1) && beta_0 * beta_1 != 0) {
      log_beta_product_values[i] <- log(abs(beta_0 * beta_1))
    } else {
      log_beta_product_values[i] <- NA
    }
  }
  
  return(list(r_squared = r_squared_values, log_beta_product = log_beta_product_values))
}

# Set seed for reproducibility
set.seed(123)

# Perform bootstrapping
bootstrap_results <- bootstrap_function(weather_df)

# Extract results
r_squared_values <- bootstrap_results$r_squared
log_beta_product_values <- bootstrap_results$log_beta_product

# Compute confidence intervals
r_squared_ci <- quantile(r_squared_values, probs = c(0.025, 0.975), na.rm = TRUE)
log_beta_product_ci <- quantile(log_beta_product_values, probs = c(0.025, 0.975), na.rm = TRUE)

# Print confidence intervals
print(paste("R-squared 95% CI:", paste(round(r_squared_ci, 3), collapse = " - ")))
print(paste("log(β0 * β1) 95% CI:", paste(round(log_beta_product_ci, 3), collapse = " - ")))

# Plot distribution of R-squared values
ggplot(data.frame(r_squared = r_squared_values), aes(x = r_squared)) +
  geom_histogram(binwidth = 0.01, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of R-squared", x = "R-squared", y = "Frequency")

# Plot distribution of log(β0 * β1) values
ggplot(data.frame(log_beta_product = log_beta_product_values), aes(x = log_beta_product)) +
  geom_histogram(binwidth = 0.05, fill = "red", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of log(β0 * β1)", x = "log(β0 * β1)", y = "Frequency")
```
```{r}
homicide_data <- read.csv("homicide-data.csv")
head(homicide_data)
```
```{r}
# Create a dummy variable 'resolved' based on the 'disposition' column
homicide_data <- homicide_data %>%
  mutate(resolved = ifelse(disposition %in% c("Closed without arrest", "Closed by arrest"), 1, 0))
head(homicide_data)

```
```{r}
homicide_data <- read.csv("homicide-data.csv") %>%
  mutate(
    resolved = ifelse(disposition %in% c("Closed without arrest", "Closed by arrest"), 1, 0),
    victim_age = as.numeric(victim_age),
    city_state = paste(city, state, sep = ", ")
  ) %>%
  filter(victim_race %in% c("White", "Black"), 
         !city %in% c("Dallas", "Tulsa"))

baltimore_data <- homicide_data %>%
  filter(city_state == "Baltimore, MD")

model_baltimore <- glm(resolved ~ victim_age + victim_sex + victim_race, 
                       data = baltimore_data, 
                       family = binomial)

summary_baltimore <- broom::tidy(model_baltimore, exponentiate = TRUE, conf.int = TRUE)
print(summary_baltimore)

nested_data <- homicide_data %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(data = map(data, ~filter(.x, !is.na(victim_age) & !is.na(victim_sex) & !is.na(victim_race))))

city_models <- nested_data %>%
  mutate(
    model = map(data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial)),
    results = map(model, ~broom::tidy(.x, exponentiate = TRUE, conf.int = TRUE))
  ) %>%
  unnest(results)

odds_ratios <- city_models %>%
  filter(term == "victim_sexMale") %>%
  select(city_state, estimate, conf.low, conf.high)

ggplot(odds_ratios, aes(x = reorder(city_state, estimate), y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  labs(title = "The odds of solving crimes for male victims and female victims in each city",
       x = "Cities",
       y = "Odds ratio (OR) and confidence interval") +
  theme_minimal(base_size = 8)

odds_ratios <- odds_ratios %>%
  arrange(desc(estimate))

head(odds_ratios)
```
The OR of 1.13 in Fresno, CA, suggests that cases involving male victims are more likely to be solved compared to those involving female victims. However, the confidence interval of 0.45–2.65 includes 1, indicating that this difference is not statistically significant. Similarly, in Minneapolis, MN, and Stockton, CA, the ORs point to a potential advantage for male victims, but the broad confidence intervals weaken the certainty of these results.
